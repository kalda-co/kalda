#!/usr/bin/env bash
set -euf -o pipefail
export MIX_ENV=prod

# Initial setup
mix deps.get --only prod
mix compile

# Compile assets
npm install
npm run deploy
mix phx.digest

# Remove the existing release directory and build the release
rm -rf "_build/prod/rel"
mix release

# Run migrations
_build/prod/rel/kalda/bin/kalda eval "Kalda.Release.migrate"
